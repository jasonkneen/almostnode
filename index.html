<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>almostnode — Node.js in your browser</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;500;600;700&family=Instrument+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
      :root {
        --black: #0c0c0c;
        --surface: #141414;
        --surface-2: #1a1a1a;
        --border: #2a2a2a;
        --border-bright: #3a3a3a;
        --text: #c0c0c0;
        --text-bright: #f0f0f0;
        --text-dim: #777;
        --accent: #00ff88;
        --accent-dim: #00cc6a;
        --accent-bg: rgba(0, 255, 136, 0.06);
        --accent-border: rgba(0, 255, 136, 0.15);
        --mono: 'IBM Plex Mono', 'Menlo', monospace;
        --sans: 'Instrument Sans', system-ui, sans-serif;
      }

      * { box-sizing: border-box; margin: 0; padding: 0; }

      body {
        font-family: var(--sans);
        background: var(--black);
        color: var(--text);
        min-height: 100vh;
        -webkit-font-smoothing: antialiased;
        position: relative;
      }

      /* Scanline overlay */
      body::after {
        content: '';
        position: fixed;
        inset: 0;
        background: repeating-linear-gradient(
          0deg,
          transparent,
          transparent 2px,
          rgba(0,0,0,0.03) 2px,
          rgba(0,0,0,0.03) 4px
        );
        pointer-events: none;
        z-index: 9999;
      }

      /* ── Nav ── */
      nav {
        position: sticky;
        top: 0;
        z-index: 100;
        background: rgba(12, 12, 12, 0.92);
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        border-bottom: 1px solid var(--border);
      }
      .nav-inner {
        max-width: 1100px;
        margin: 0 auto;
        padding: 0 24px;
        height: 52px;
        display: flex;
        align-items: center;
        justify-content: space-between;
      }
      .nav-logo {
        font-family: var(--mono);
        font-size: 0.9rem;
        font-weight: 600;
        color: var(--accent);
        text-decoration: none;
        letter-spacing: -0.01em;
      }
      .nav-links {
        display: flex;
        gap: 24px;
        list-style: none;
      }
      .nav-links a {
        font-family: var(--mono);
        font-size: 0.78rem;
        color: var(--text-dim);
        text-decoration: none;
        text-transform: uppercase;
        letter-spacing: 0.06em;
        transition: color 0.15s;
      }
      .nav-links a:hover { color: var(--text-bright); }

      /* ── Hero ── */
      .hero {
        padding: 96px 24px 72px;
        max-width: 1100px;
        margin: 0 auto;
      }
      .hero-label {
        font-family: var(--mono);
        font-size: 0.72rem;
        text-transform: uppercase;
        letter-spacing: 0.12em;
        color: var(--accent);
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        gap: 10px;
      }
      .hero-label::before {
        content: '';
        width: 20px;
        height: 1px;
        background: var(--accent);
      }
      .hero h1 {
        font-family: var(--sans);
        font-size: clamp(2.8rem, 7vw, 4.5rem);
        font-weight: 700;
        color: var(--text-bright);
        letter-spacing: -0.04em;
        line-height: 1.05;
        margin-bottom: 24px;
        max-width: 700px;
      }
      .hero .subtitle {
        font-size: 1.1rem;
        color: var(--text);
        line-height: 1.65;
        max-width: 520px;
        margin-bottom: 40px;
      }

      /* Install box */
      .install-box {
        display: inline-flex;
        align-items: center;
        gap: 14px;
        background: var(--surface);
        border: 1px solid var(--border);
        padding: 14px 18px;
        margin-bottom: 28px;
        font-family: var(--mono);
        font-size: 0.88rem;
      }
      .install-box .prompt { color: var(--accent); user-select: none; }
      .install-box code { color: var(--text-bright); }
      .install-box button {
        background: none;
        border: 1px solid var(--border);
        color: var(--text-dim);
        cursor: pointer;
        padding: 4px 6px;
        display: flex;
        align-items: center;
        transition: color 0.15s, border-color 0.15s;
      }
      .install-box button:hover {
        color: var(--accent);
        border-color: var(--accent-border);
      }
      .install-box button svg { width: 14px; height: 14px; }

      /* CTA row */
      .cta-row {
        display: flex;
        gap: 12px;
        margin-bottom: 32px;
      }
      .btn {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 12px 28px;
        font-family: var(--mono);
        font-size: 0.82rem;
        font-weight: 500;
        text-decoration: none;
        text-transform: uppercase;
        letter-spacing: 0.04em;
        transition: all 0.15s;
        border: 1px solid transparent;
      }
      .btn-primary {
        background: var(--accent);
        color: var(--black);
      }
      .btn-primary:hover {
        background: #00ffaa;
        box-shadow: 0 0 20px rgba(0, 255, 136, 0.2);
      }
      .btn-secondary {
        background: transparent;
        border-color: var(--border);
        color: var(--text);
      }
      .btn-secondary:hover {
        border-color: var(--text-dim);
        color: var(--text-bright);
      }
      .btn svg { width: 15px; height: 15px; }

      /* Badges */
      .badges {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
      }
      .badges a { text-decoration: none; line-height: 0; }
      .badges img { height: 20px; }

      /* ── Section ── */
      .section {
        max-width: 1100px;
        margin: 0 auto;
        padding: 0 24px;
      }
      .section-header {
        padding: 80px 0 48px;
        border-top: 1px solid var(--border);
      }
      .section-label {
        font-family: var(--mono);
        font-size: 0.68rem;
        text-transform: uppercase;
        letter-spacing: 0.12em;
        color: var(--text-dim);
        margin-bottom: 12px;
      }
      .section-header h2 {
        font-family: var(--sans);
        font-size: 1.6rem;
        font-weight: 700;
        color: var(--text-bright);
        letter-spacing: -0.02em;
      }

      /* ── Code examples ── */
      .code-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 1px;
        background: var(--border);
        border: 1px solid var(--border);
        margin-bottom: 80px;
      }
      @media (max-width: 900px) {
        .code-grid { grid-template-columns: 1fr; }
      }
      .code-card {
        background: var(--surface);
        overflow: hidden;
      }
      .code-card:hover { background: var(--surface-2); }
      .code-tab {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 10px 16px;
        border-bottom: 1px solid var(--border);
        font-family: var(--mono);
        font-size: 0.72rem;
        color: var(--text-dim);
      }
      .code-tab .indicator {
        width: 6px;
        height: 6px;
        background: var(--accent);
      }
      .code-card pre {
        padding: 16px;
        overflow-x: auto;
        font-family: var(--mono);
        font-size: 0.75rem;
        line-height: 1.7;
        color: var(--text);
        scrollbar-width: thin;
        scrollbar-color: var(--border) transparent;
      }
      /* Syntax — muted, monochrome-forward with accent pops */
      .kw { color: var(--accent); }
      .str { color: #e8c872; }
      .fn { color: var(--text-bright); }
      .cm { color: #666; }
      .op { color: #888; }
      .num { color: #e8c872; }

      /* ── Features ── */
      .features-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 1px;
        background: var(--border);
        border: 1px solid var(--border);
        margin-bottom: 80px;
      }
      @media (max-width: 768px) {
        .features-grid { grid-template-columns: 1fr; }
      }
      @media (min-width: 769px) and (max-width: 1024px) {
        .features-grid { grid-template-columns: repeat(2, 1fr); }
      }
      .feature-card {
        background: var(--surface);
        padding: 28px 24px;
        transition: background 0.15s;
      }
      .feature-card:hover { background: var(--surface-2); }
      .feature-icon {
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 16px;
        border: 1px solid var(--accent-border);
        background: var(--accent-bg);
      }
      .feature-icon svg {
        width: 16px;
        height: 16px;
        stroke: var(--accent);
        fill: none;
        stroke-width: 1.5;
        stroke-linecap: round;
        stroke-linejoin: round;
      }
      .feature-card h3 {
        font-family: var(--mono);
        font-size: 0.82rem;
        font-weight: 600;
        color: var(--text-bright);
        margin-bottom: 8px;
        letter-spacing: -0.01em;
      }
      .feature-card p {
        font-size: 0.85rem;
        color: var(--text-dim);
        line-height: 1.55;
      }

      /* ── Demos ── */
      .demos-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 1px;
        background: var(--border);
        border: 1px solid var(--border);
        margin-bottom: 80px;
      }
      @media (max-width: 900px) {
        .demos-grid { grid-template-columns: repeat(2, 1fr); }
      }
      @media (max-width: 520px) {
        .demos-grid { grid-template-columns: 1fr; }
      }
      .demo-card {
        display: block;
        background: var(--surface);
        padding: 24px 20px;
        text-decoration: none;
        color: inherit;
        transition: background 0.15s;
      }
      .demo-card:hover {
        background: var(--surface-2);
      }
      .demo-card:hover h3 { color: var(--accent); }
      .demo-card h3 {
        font-family: var(--mono);
        font-size: 0.85rem;
        font-weight: 600;
        color: var(--text-bright);
        margin-bottom: 8px;
        transition: color 0.15s;
      }
      .demo-card p {
        font-size: 0.82rem;
        color: var(--text-dim);
        line-height: 1.5;
        margin-bottom: 14px;
      }
      .demo-tag {
        display: inline-block;
        padding: 2px 8px;
        font-family: var(--mono);
        font-size: 0.65rem;
        text-transform: uppercase;
        letter-spacing: 0.04em;
        background: var(--accent-bg);
        color: var(--accent-dim);
        border: 1px solid var(--accent-border);
      }

      /* ── Footer ── */
      footer {
        border-top: 1px solid var(--border);
        padding: 28px 24px;
        max-width: 1100px;
        margin: 0 auto;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      footer .footer-links {
        display: flex;
        gap: 20px;
      }
      footer a {
        font-family: var(--mono);
        font-size: 0.72rem;
        color: var(--text-dim);
        text-decoration: none;
        text-transform: uppercase;
        letter-spacing: 0.06em;
        transition: color 0.15s;
      }
      footer a:hover { color: var(--text-bright); }
      footer .license {
        font-family: var(--mono);
        font-size: 0.7rem;
        color: var(--text-dim);
      }

      /* ── Responsive ── */
      @media (max-width: 600px) {
        .nav-links { gap: 14px; }
        .nav-links a { font-size: 0.7rem; }
        .hero { padding: 64px 20px 56px; }
        .hero h1 { font-size: 2.2rem; }
        .cta-row { flex-direction: column; }
        .btn { justify-content: center; }
        footer { flex-direction: column; gap: 12px; text-align: center; }
      }

      /* ── REPL ── */
      .repl-container {
        max-width: 1100px;
        margin: 0 auto;
        padding: 0 24px 80px;
      }
      .repl {
        border: 1px solid var(--border);
        background: var(--surface);
        overflow: hidden;
      }
      .repl-header {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 10px 16px;
        border-bottom: 1px solid var(--border);
        background: var(--black);
      }
      .repl-header .indicator {
        width: 6px;
        height: 6px;
        background: var(--accent);
      }
      .repl-header span {
        font-family: var(--mono);
        font-size: 0.72rem;
        color: var(--text-dim);
      }
      .repl-header .repl-clear {
        margin-left: auto;
        background: none;
        border: 1px solid var(--border);
        color: var(--text-dim);
        font-family: var(--mono);
        font-size: 0.65rem;
        text-transform: uppercase;
        letter-spacing: 0.06em;
        padding: 3px 10px;
        cursor: pointer;
        transition: color 0.15s, border-color 0.15s;
      }
      .repl-header .repl-clear:hover {
        color: var(--text-bright);
        border-color: var(--border-bright);
      }
      .repl-output {
        padding: 16px;
        font-family: var(--mono);
        font-size: 0.78rem;
        line-height: 1.7;
        min-height: 200px;
        max-height: 320px;
        overflow-y: auto;
        scrollbar-width: thin;
        scrollbar-color: var(--border) transparent;
      }
      .repl-output .repl-line-input {
        color: var(--text-bright);
      }
      .repl-output .repl-line-input::before {
        content: '> ';
        color: var(--accent);
      }
      .repl-output .repl-line-output {
        color: var(--text);
        padding-left: 18px;
      }
      .repl-output .repl-line-error {
        color: #ff6b6b;
        padding-left: 18px;
      }
      .repl-output .repl-line-log {
        color: var(--text);
        padding-left: 18px;
      }
      .repl-output .repl-line-log::before {
        content: '';
      }
      .repl-input-row {
        display: flex;
        align-items: center;
        border-top: 1px solid var(--border);
        background: var(--black);
      }
      .repl-prompt {
        padding: 0 0 0 16px;
        font-family: var(--mono);
        font-size: 0.82rem;
        color: var(--accent);
        user-select: none;
      }
      .repl-input {
        flex: 1;
        padding: 12px 16px 12px 8px;
        background: transparent;
        border: none;
        outline: none;
        font-family: var(--mono);
        font-size: 0.78rem;
        color: var(--text-bright);
        caret-color: var(--accent);
      }
      .repl-input::placeholder {
        color: var(--text-dim);
      }
      .repl-body {
        display: flex;
      }
      .repl-main {
        flex: 1;
        min-width: 0;
      }
      .repl-files {
        width: 200px;
        flex-shrink: 0;
        border-left: 1px solid var(--border);
        display: none;
      }
      .repl-files.has-files {
        display: block;
      }
      .repl-files-header {
        padding: 8px 12px;
        font-family: var(--mono);
        font-size: 0.6rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        color: var(--text-dim);
        border-bottom: 1px solid var(--border);
        background: var(--black);
      }
      .repl-files-list {
        padding: 6px 0;
        max-height: 280px;
        overflow-y: auto;
        scrollbar-width: thin;
        scrollbar-color: var(--border) transparent;
      }
      .repl-file-item {
        display: flex;
        align-items: center;
        gap: 6px;
        padding: 4px 12px;
        font-family: var(--mono);
        font-size: 0.7rem;
        color: var(--text-dim);
        cursor: pointer;
        transition: color 0.15s, background 0.15s;
      }
      .repl-file-item:hover {
        color: var(--text-bright);
        background: var(--accent-bg);
      }
      .repl-file-item.active {
        color: var(--accent);
        background: var(--accent-bg);
      }
      .repl-file-item svg {
        width: 12px;
        height: 12px;
        flex-shrink: 0;
        opacity: 0.5;
      }
      .repl-file-item span {
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }
      .repl-file-viewer {
        display: none;
        border-top: 1px solid var(--border);
        background: var(--black);
      }
      .repl-file-viewer.open {
        display: block;
      }
      .repl-file-viewer-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 6px 12px;
        border-bottom: 1px solid var(--border);
      }
      .repl-file-viewer-header span {
        font-family: var(--mono);
        font-size: 0.68rem;
        color: var(--accent);
      }
      .repl-file-viewer-close {
        background: none;
        border: none;
        color: var(--text-dim);
        cursor: pointer;
        font-size: 0.85rem;
        padding: 0 4px;
        line-height: 1;
      }
      .repl-file-viewer-close:hover {
        color: var(--text-bright);
      }
      .repl-file-viewer pre {
        padding: 10px 12px;
        margin: 0;
        font-family: var(--mono);
        font-size: 0.72rem;
        line-height: 1.6;
        color: var(--text);
        max-height: 150px;
        overflow: auto;
        scrollbar-width: thin;
        scrollbar-color: var(--border) transparent;
        white-space: pre-wrap;
        word-break: break-all;
      }
      @media (max-width: 768px) {
        .repl-body { flex-direction: column; }
        .repl-files { width: 100%; border-left: none; border-top: 1px solid var(--border); }
        .repl-files-list { max-height: 120px; }
      }
      .repl-examples {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
        padding: 10px 16px;
        border-top: 1px solid var(--border);
      }
      .repl-example-btn {
        background: var(--accent-bg);
        border: 1px solid var(--accent-border);
        color: var(--accent-dim);
        font-family: var(--mono);
        font-size: 0.65rem;
        padding: 3px 10px;
        cursor: pointer;
        transition: background 0.15s, color 0.15s;
      }
      .repl-example-btn:hover {
        background: rgba(0, 255, 136, 0.12);
        color: var(--accent);
      }

      /* ── Entrance animations ── */
      @keyframes fadeUp {
        from { opacity: 0; transform: translateY(16px); }
        to { opacity: 1; transform: translateY(0); }
      }
      .hero-label, .hero h1, .hero .subtitle,
      .install-box, .cta-row, .badges {
        animation: fadeUp 0.5s ease both;
      }
      .hero h1 { animation-delay: 0.05s; }
      .hero .subtitle { animation-delay: 0.1s; }
      .install-box { animation-delay: 0.15s; }
      .cta-row { animation-delay: 0.2s; }
      .badges { animation-delay: 0.25s; }
    </style>
  </head>
  <body>

    <!-- Nav -->
    <nav>
      <div class="nav-inner">
        <a href="./" class="nav-logo">almostnode</a>
        <ul class="nav-links">
          <li><a href="./docs/">Docs</a></li>
          <li><a href="#demos">Examples</a></li>
          <li><a href="https://github.com/macaly/almostnode">GitHub</a></li>
          <li><a href="https://www.npmjs.com/package/almostnode">npm</a></li>
        </ul>
      </div>
    </nav>

    <!-- Hero -->
    <section class="hero">
      <div class="hero-label">Open Source</div>
      <h1>Node.js in your browser</h1>
      <p class="subtitle">Run Node.js, Next.js, Vite, and Express entirely in the browser. No server required.</p>

      <div class="install-box">
        <span class="prompt">$</span>
        <code>npm install almostnode</code>
        <button onclick="navigator.clipboard.writeText('npm install almostnode').then(()=>{this.innerHTML='<svg viewBox=&quot;0 0 24 24&quot; fill=&quot;none&quot; stroke=&quot;currentColor&quot; stroke-width=&quot;2&quot;><polyline points=&quot;20 6 9 17 4 12&quot;/></svg>';setTimeout(()=>{this.innerHTML='<svg viewBox=&quot;0 0 24 24&quot; fill=&quot;none&quot; stroke=&quot;currentColor&quot; stroke-width=&quot;2&quot;><rect x=&quot;9&quot; y=&quot;9&quot; width=&quot;13&quot; height=&quot;13&quot; rx=&quot;2&quot;/><path d=&quot;M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1&quot;/></svg>'},1500)})" aria-label="Copy">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"/></svg>
        </button>
      </div>

      <div class="cta-row">
        <a href="./docs/" class="btn btn-primary">Get Started</a>
        <a href="https://github.com/macaly/almostnode" class="btn btn-secondary">
          <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.477 2 2 6.484 2 12.017c0 4.425 2.865 8.18 6.839 9.504.5.092.682-.217.682-.483 0-.237-.008-.868-.013-1.703-2.782.605-3.369-1.343-3.369-1.343-.454-1.158-1.11-1.466-1.11-1.466-.908-.62.069-.608.069-.608 1.003.07 1.531 1.032 1.531 1.032.892 1.53 2.341 1.088 2.91.832.092-.647.35-1.088.636-1.338-2.22-.253-4.555-1.113-4.555-4.951 0-1.093.39-1.988 1.029-2.688-.103-.253-.446-1.272.098-2.65 0 0 .84-.27 2.75 1.026A9.564 9.564 0 0112 6.844c.85.004 1.705.115 2.504.337 1.909-1.296 2.747-1.027 2.747-1.027.546 1.379.202 2.398.1 2.651.64.7 1.028 1.595 1.028 2.688 0 3.848-2.339 4.695-4.566 4.943.359.309.678.92.678 1.855 0 1.338-.012 2.419-.012 2.747 0 .268.18.58.688.482A10.019 10.019 0 0022 12.017C22 6.484 17.522 2 12 2z"/></svg>
          GitHub
        </a>
      </div>

      <div class="badges">
        <a href="https://www.npmjs.com/package/almostnode"><img src="https://img.shields.io/npm/v/almostnode?style=flat-square&color=00ff88&labelColor=141414" alt="npm version"></a>
        <a href="https://github.com/macaly/almostnode"><img src="https://img.shields.io/github/stars/macaly/almostnode?style=flat-square&color=00ff88&labelColor=141414" alt="GitHub stars"></a>
        <a href="https://github.com/macaly/almostnode/blob/main/LICENSE"><img src="https://img.shields.io/github/license/macaly/almostnode?style=flat-square&color=00ff88&labelColor=141414" alt="License"></a>
      </div>
    </section>

    <!-- REPL -->
    <div class="repl-container">
      <div class="repl">
        <div class="repl-header">
          <span class="indicator"></span>
          <span>node repl — try it right here</span>
          <button class="repl-clear" id="repl-clear">Clear</button>
        </div>
        <div class="repl-body">
          <div class="repl-main">
            <div class="repl-output" id="repl-output">
              <div class="repl-line-log">Welcome to almostnode REPL. Type JavaScript and press Enter.</div>
              <div class="repl-line-log">Try: <span style="color:var(--accent)">require('path').join('/foo', 'bar')</span> or <span style="color:var(--accent)">require('crypto').randomUUID()</span></div>
            </div>
          </div>
          <div class="repl-files" id="repl-files">
            <div class="repl-files-header">Files</div>
            <div class="repl-files-list" id="repl-files-list"></div>
          </div>
        </div>
        <div class="repl-file-viewer" id="repl-file-viewer">
          <div class="repl-file-viewer-header">
            <span id="repl-file-viewer-name"></span>
            <button class="repl-file-viewer-close" id="repl-file-viewer-close">&times;</button>
          </div>
          <pre id="repl-file-viewer-content"></pre>
        </div>
        <div class="repl-examples">
          <button class="repl-example-btn" data-code="require('path').join('/foo', 'bar', 'baz.js')">path.join</button>
          <button class="repl-example-btn" data-code="require('crypto').randomUUID()">crypto.randomUUID</button>
          <button class="repl-example-btn" data-code="require('os').platform()">os.platform</button>
          <button class="repl-example-btn" data-code="Buffer.from('hello world').toString('base64')">Buffer base64</button>
          <button class="repl-example-btn" data-code="const fs = require('fs'); fs.writeFileSync('/hello.txt', 'Hello!'); fs.readFileSync('/hello.txt', 'utf8')">fs read/write</button>
          <button class="repl-example-btn" data-code="JSON.stringify(require('url').parse('https://example.com/path?q=1'), null, 2)">url.parse</button>
        </div>
        <div class="repl-input-row">
          <span class="repl-prompt">&gt;</span>
          <input type="text" class="repl-input" id="repl-input" placeholder="Type JavaScript here..." autocomplete="off" spellcheck="false">
        </div>
      </div>
    </div>

    <script type="module">
      import { createContainer } from '/src/index.ts';

      const container = createContainer();
      const repl = container.createREPL();
      const output = document.getElementById('repl-output');
      const input = document.getElementById('repl-input');

      // Capture console.log from the runtime
      container.runtime.onConsole = (method, args) => {
        const line = document.createElement('div');
        line.className = 'repl-line-log';
        line.textContent = args.map(a => {
          if (typeof a === 'object') {
            try { return JSON.stringify(a, null, 2); } catch { return String(a); }
          }
          return String(a);
        }).join(' ');
        output.appendChild(line);
      };

      function formatVal(val) {
        if (val === undefined) return undefined;
        if (val === null) return 'null';
        if (typeof val === 'string') return JSON.stringify(val);
        if (typeof val === 'object') {
          try { return JSON.stringify(val, null, 2); } catch { return String(val); }
        }
        return String(val);
      }

      function execRepl(code) {
        const inputLine = document.createElement('div');
        inputLine.className = 'repl-line-input';
        inputLine.textContent = code;
        output.appendChild(inputLine);

        try {
          const val = repl.eval(code);
          const formatted = formatVal(val);
          if (formatted !== undefined) {
            const outLine = document.createElement('div');
            outLine.className = 'repl-line-output';
            outLine.textContent = formatted;
            output.appendChild(outLine);
          }
        } catch (e) {
          const errLine = document.createElement('div');
          errLine.className = 'repl-line-error';
          errLine.textContent = e.message || String(e);
          output.appendChild(errLine);
        }
        output.scrollTop = output.scrollHeight;
      }

      input.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && input.value.trim()) {
          execRepl(input.value.trim());
          input.value = '';
        }
      });

      document.getElementById('repl-clear').addEventListener('click', () => {
        output.innerHTML = '';
      });

      document.querySelectorAll('.repl-example-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          execRepl(btn.dataset.code);
          input.focus();
        });
      });

      // File sidebar — watches VFS for file changes
      const filesPanel = document.getElementById('repl-files');
      const filesList = document.getElementById('repl-files-list');
      const fileViewer = document.getElementById('repl-file-viewer');
      const fileViewerName = document.getElementById('repl-file-viewer-name');
      const fileViewerContent = document.getElementById('repl-file-viewer-content');
      const trackedFiles = new Set();
      const IGNORE = ['/index.js', '/node_modules'];

      function shouldTrack(path) {
        return IGNORE.every(p => !path.startsWith(p));
      }

      function refreshFiles() {
        function walk(dir) {
          try {
            const entries = container.vfs.readdirSync(dir);
            for (const entry of entries) {
              const full = dir === '/' ? '/' + entry : dir + '/' + entry;
              if (!shouldTrack(full)) continue;
              try {
                const stat = container.vfs.statSync(full);
                if (stat.isDirectory()) { walk(full); }
                else { trackedFiles.add(full); }
              } catch {}
            }
          } catch {}
        }
        trackedFiles.clear();
        walk('/');
        renderFiles();
      }

      function renderFiles() {
        filesList.innerHTML = '';
        const sorted = [...trackedFiles].sort();
        filesPanel.classList.toggle('has-files', sorted.length > 0);
        for (const path of sorted) {
          const item = document.createElement('div');
          item.className = 'repl-file-item';
          item.innerHTML = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/></svg><span>${path}</span>`;
          item.addEventListener('click', () => openFile(path));
          filesList.appendChild(item);
        }
      }

      function openFile(path) {
        try {
          const content = container.vfs.readFileSync(path, 'utf8');
          fileViewerName.textContent = path;
          fileViewerContent.textContent = content;
          fileViewer.classList.add('open');
          filesList.querySelectorAll('.repl-file-item').forEach(el => {
            el.classList.toggle('active', el.querySelector('span').textContent === path);
          });
        } catch (e) {
          fileViewerName.textContent = path;
          fileViewerContent.textContent = 'Error: ' + e.message;
          fileViewer.classList.add('open');
        }
      }

      document.getElementById('repl-file-viewer-close').addEventListener('click', () => {
        fileViewer.classList.remove('open');
        filesList.querySelectorAll('.repl-file-item').forEach(el => el.classList.remove('active'));
      });

      // Watch VFS for changes
      container.vfs.on('change', (path) => {
        if (shouldTrack(path)) {
          trackedFiles.add(path);
          renderFiles();
          // If this file is currently open, refresh its content
          if (fileViewer.classList.contains('open') && fileViewerName.textContent === path) {
            openFile(path);
          }
        }
      });
    </script>

    <!-- Code Examples -->
    <div class="section">
      <div class="section-header">
        <div class="section-label">01 / Code</div>
        <h2>See it in action</h2>
      </div>
      <div class="code-grid">

        <div class="code-card">
          <div class="code-tab"><span class="indicator"></span> server.ts</div>
          <pre><span class="kw">import</span> <span class="op">{</span> <span class="fn">createContainer</span> <span class="op">}</span> <span class="kw">from</span> <span class="str">'almostnode'</span><span class="op">;</span>

<span class="kw">const</span> <span class="op">{</span> vfs<span class="op">,</span> runtime <span class="op">}</span> <span class="op">=</span> <span class="fn">createContainer</span><span class="op">();</span>

vfs<span class="op">.</span><span class="fn">writeFileSync</span><span class="op">(</span><span class="str">'/server.js'</span><span class="op">,</span> <span class="str">`
  const http = require('http');
  http.createServer((req, res) =&gt; {
    res.writeHead(200);
    res.end('Hello from the browser!');
  }).listen(3000);
`</span><span class="op">);</span>

runtime<span class="op">.</span><span class="fn">runFile</span><span class="op">(</span><span class="str">'/server.js'</span><span class="op">);</span></pre>
        </div>

        <div class="code-card">
          <div class="code-tab"><span class="indicator"></span> app.ts</div>
          <pre><span class="kw">import</span> <span class="op">{</span> <span class="fn">createContainer</span> <span class="op">}</span> <span class="kw">from</span> <span class="str">'almostnode'</span><span class="op">;</span>

<span class="kw">const</span> <span class="op">{</span> vfs<span class="op">,</span> npm<span class="op">,</span> runtime <span class="op">}</span> <span class="op">=</span> <span class="fn">createContainer</span><span class="op">();</span>

<span class="kw">await</span> npm<span class="op">.</span><span class="fn">install</span><span class="op">(</span><span class="str">'express'</span><span class="op">);</span>

vfs<span class="op">.</span><span class="fn">writeFileSync</span><span class="op">(</span><span class="str">'/app.js'</span><span class="op">,</span> <span class="str">`
  const express = require('express');
  const app = express();
  app.get('/api', (req, res) =&gt; {
    res.json({ source: 'browser' });
  });
  app.listen(3000);
`</span><span class="op">);</span>

runtime<span class="op">.</span><span class="fn">runFile</span><span class="op">(</span><span class="str">'/app.js'</span><span class="op">);</span></pre>
        </div>

        <div class="code-card">
          <div class="code-tab"><span class="indicator"></span> next-app.ts</div>
          <pre><span class="kw">import</span> <span class="op">{</span> VirtualFS<span class="op">,</span> NextDevServer<span class="op">,</span>
  <span class="fn">getServerBridge</span> <span class="op">}</span> <span class="kw">from</span> <span class="str">'almostnode'</span><span class="op">;</span>

<span class="kw">const</span> vfs <span class="op">=</span> <span class="kw">new</span> <span class="fn">VirtualFS</span><span class="op">();</span>
<span class="kw">const</span> server <span class="op">=</span> <span class="kw">new</span> <span class="fn">NextDevServer</span><span class="op">(</span>vfs<span class="op">);</span>
<span class="kw">const</span> bridge <span class="op">=</span> <span class="fn">getServerBridge</span><span class="op">();</span>

vfs<span class="op">.</span><span class="fn">writeFileSync</span><span class="op">(</span><span class="str">'/app/page.tsx'</span><span class="op">,</span> <span class="str">`
  export default function Home() {
    return &lt;h1&gt;Next.js in the browser!&lt;/h1&gt;;
  }
`</span><span class="op">);</span>

<span class="kw">await</span> bridge<span class="op">.</span><span class="fn">initServiceWorker</span><span class="op">();</span>
bridge<span class="op">.</span><span class="fn">registerServer</span><span class="op">(</span>server<span class="op">,</span> <span class="num">3000</span><span class="op">);</span></pre>
        </div>

      </div>
    </div>

    <!-- Features -->
    <div class="section">
      <div class="section-header">
        <div class="section-label">02 / Features</div>
        <h2>Everything you need</h2>
      </div>
      <div class="features-grid">

        <div class="feature-card">
          <div class="feature-icon">
            <svg viewBox="0 0 24 24"><path d="M22 19a2 2 0 01-2 2H4a2 2 0 01-2-2V5a2 2 0 012-2h5l2 3h9a2 2 0 012 2z"/></svg>
          </div>
          <h3>Virtual Filesystem</h3>
          <p>POSIX-compatible in-memory filesystem with watch, stat, and recursive operations.</p>
        </div>

        <div class="feature-card">
          <div class="feature-icon">
            <svg viewBox="0 0 24 24"><polyline points="4 17 10 11 4 5"/><line x1="12" y1="19" x2="20" y2="19"/></svg>
          </div>
          <h3>Node.js Runtime</h3>
          <p>Execute JS/TS with 40+ shimmed modules — fs, path, http, crypto, streams, and more.</p>
        </div>

        <div class="feature-card">
          <div class="feature-icon">
            <svg viewBox="0 0 24 24"><path d="M21 16V8a2 2 0 00-1-1.73l-7-4a2 2 0 00-2 0l-7 4A2 2 0 003 8v8a2 2 0 001 1.73l7 4a2 2 0 002 0l7-4A2 2 0 0021 16z"/><polyline points="3.27 6.96 12 12.01 20.73 6.96"/><line x1="12" y1="22.08" x2="12" y2="12"/></svg>
          </div>
          <h3>npm in the Browser</h3>
          <p>Install real npm packages, resolve dependencies, extract tarballs — all client-side.</p>
        </div>

        <div class="feature-card">
          <div class="feature-icon">
            <svg viewBox="0 0 24 24"><rect x="2" y="3" width="20" height="14" rx="2"/><line x1="8" y1="21" x2="16" y2="21"/><line x1="12" y1="17" x2="12" y2="21"/></svg>
          </div>
          <h3>Framework Dev Servers</h3>
          <p>Built-in Next.js and Vite dev servers with file-based routing and React support.</p>
        </div>

        <div class="feature-card">
          <div class="feature-icon">
            <svg viewBox="0 0 24 24"><polyline points="23 4 23 10 17 10"/><polyline points="1 20 1 14 7 14"/><path d="M3.51 9a9 9 0 0114.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0020.49 15"/></svg>
          </div>
          <h3>Hot Module Replacement</h3>
          <p>React Refresh, CSS Modules, and instant file updates without page reload.</p>
        </div>

        <div class="feature-card">
          <div class="feature-icon">
            <svg viewBox="0 0 24 24"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>
          </div>
          <h3>Security Modes</h3>
          <p>Cross-origin sandbox, Web Worker isolation, or same-origin main thread execution.</p>
        </div>

      </div>
    </div>

    <!-- Demos -->
    <div class="section" id="demos">
      <div class="section-header">
        <div class="section-label">03 / Demos</div>
        <h2>Try it live</h2>
      </div>
      <div class="demos-grid">

        <a class="demo-card" href="./examples/index.html">
          <h3>HTTP Server</h3>
          <p>Run a Node.js HTTP server in the browser. Edit the code, hit Run, and see it serve pages live.</p>
          <span class="demo-tag">http · require()</span>
        </a>

        <a class="demo-card" href="./examples/next-demo.html">
          <h3>Next.js App</h3>
          <p>A full Next.js development server with App Router, file-based routing, and HMR.</p>
          <span class="demo-tag">next.js · app router · hmr</span>
        </a>

        <a class="demo-card" href="./examples/vite-demo.html">
          <h3>Vite Dev Server</h3>
          <p>Vite running in the browser with React, hot module replacement, and npm packages.</p>
          <span class="demo-tag">vite · react · hmr</span>
        </a>

        <a class="demo-card" href="./examples/express-demo.html">
          <h3>Express Server</h3>
          <p>Express.js with routing, middleware, and JSON APIs — entirely in your browser.</p>
          <span class="demo-tag">express · npm install</span>
        </a>

      </div>
    </div>

    <!-- Footer -->
    <footer>
      <div class="footer-links">
        <a href="https://github.com/macaly/almostnode">GitHub</a>
        <a href="https://www.npmjs.com/package/almostnode">npm</a>
        <a href="./docs/">Docs</a>
      </div>
      <span class="license">MIT License</span>
    </footer>

  </body>
</html>
